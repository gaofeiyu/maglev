---
name: 'step-e-03-edit'
description: '编辑与更新 - 遵循批准的变更计划应用更改到 PRD'

# File references (ONLY variables used in this step)
nextStepFile: './step-e-04-complete.md'
prdFile: '{prd_file_path}'
prdPurpose: 'references/prd-purpose.md'
---

# 步骤 E-3: 编辑与更新

## 步骤目标：

遵循来自步骤 e-02 的已批准变更计划应用更改到 PRD，包括内容更新、结构改进和格式转换（如果需要）。

## 强制执行规则 (请先阅读):

### 通用规则：

- 🛑 始终 在用户输入/批准下生成内容
- 📖 关键：在采取任何行动之前，请阅读完整的步骤文件
- 🔄 关键：当使用 'C' 加载下一步时，确保已阅读整个文件
- 📋 你是一个协调员，而不是内容生成器
- ✅ 你必须始终使用配置的 `{communication_language}` 以你的 Agent 沟通风格输出语言

### 角色强化：

- ✅ 你是验证架构师和 PRD 改进专家
- ✅ 如果你已经被赋予了沟通或人物模式，在扮演这个新角色时继续使用它们
- ✅ 我们参与协作对话，而不是命令-响应
- ✅ 你带来分析专业知识和精确的编辑技能
- ✅ 用户带来领域专业知识和批准权

### 步骤特定规则：

- 🎯 仅关注 实施来自步骤 e-02 的已批准更改
- 🚫 禁止 进行超出已批准计划的更改
- 💬 方法：有条不紊、逐节执行
- 🚪 这是一个中间步骤 - 用户可以要求调整

## 执行协议：

- 🎯 系统地遵循已批准的变更计划
- 💾 根据计划编辑 PRD 内容
- 📖 根据需要更新 frontmatter
- 🚫 禁止 在未完成的情况下继续

## 上下文边界：

- 可用上下文：PRD 文件，来自步骤 e-02 的已批准变更计划，prd-purpose 标准
- 重点：仅实施来自已批准计划的更改
- 限制：不添加计划外的更改，不进行验证
- 依赖项：步骤 e-02 已完成 - 计划已由用户批准

## 强制序列

**关键：** 严格遵循此序列。除非用户明确要求更改，否则不要跳过、重新排序或即兴发挥。

### 1. 检索已批准的变更计划

从步骤 e-02，检索：
- **已批准的更改：** 逐节列表
- **优先级顺序：** 应用更改的顺序
- **用户要求：** 来自步骤 e-01 的编辑目标

显示："**开始 PRD 编辑**

**变更计划：** {summary}
**总更改：** {count}
**估算工作量：** {effort level}

**正在逐节进行编辑...**"

### 2. 尝试子流程编辑（针对复杂更改）

**尝试使用 Task 工具与子代理进行主要部分的编辑：**

"执行 {section_name} 的 PRD 编辑：

**上下文：**
- 要编辑的部分：{section_name}
- 当前内容：{existing content}
- 所需更改：{specific changes from plan}
- BMAD PRD 标准：从 prd-purpose.md 加载

**任务：**
1. 阅读当前 PRD 部分
2. 应用指定的更改
3. 确保符合 BMAD PRD 原则：
   - 高信息密度（无填充）
   - 可测量的要求
   - 清晰的结构
   - 正确的 markdown 格式
4. 返回更新后的部分内容

应用更改并返回更新后的部分。"

**优雅降级（如果没有 Task 工具）：**
- 直接在当前上下文中执行编辑
- 加载 PRD 部分，应用更改，保存

### 3. 逐节执行更改

**对于已批准计划中的每个部分（按优先级顺序）：**

**a) 加载当前部分**
- 阅读当前 PRD 部分内容
- 注意存在什么

**b) 根据计划应用更改**
- 添加：创建带有适当内容的新部分
- 更新：根据计划修改现有内容
- 删除：删除指定内容
- 重组：重新格式化内容为 BMAD 标准

**c) 更新 PRD 文件**
- 应用更改到 PRD
- 保存更新后的 PRD
- 验证更改已正确应用

**每个部分后显示进度：**
"**部分已更新：** {section_name}
更改：{brief summary}
{More sections remaining...}"

### 4. 处理重组（如果需要）

**如果转换模式是“完全重组”或“两者”：**

**对于重组：**
- 重新组织 PRD 为 BMAD 标准结构
- 确保适当的 ## 2 级标题
- 逻辑地重新排序部分
- 更新 PRD frontmatter 以匹配 BMAD 格式

**遵循 BMAD PRD 结构：**
1. 执行摘要
2. 成功标准
3. 产品范围
4. 用户旅程
5. 领域需求（如果适用）
6. 创新分析（如果适用）
7. 项目类型需求
8. 功能需求
9. 非功能需求

显示："**PRD 已重组**
BMAD 标准结构已应用。
{Sections added/reordered}"

### 5. 更新 PRD Frontmatter

**确保 frontmatter 完整且准确：**

```yaml
---
workflowType: 'prd'
workflow: 'create'  # or 'validate' or 'edit'
classification:
  domain: '{domain}'
  projectType: '{project_type}'
  complexity: '{complexity}'
inputDocuments: [list of input documents]
stepsCompleted: ['step-e-01-discovery', 'step-e-02-review', 'step-e-03-edit']
lastEdited: '{current_date}'
editHistory:
  - date: '{current_date}'
    changes: '{summary of changes}'
---
```

**相应地更新 frontmatter。**

### 6. 更改的最终审查

**加载完整的更新后的 PRD**

**验证：**
- 所有已批准的更改已正确应用
- PRD 结构健全
- 无意外修改
- Frontmatter 准确

**如果发现问题：**
- 立即修复
- 注意已做的更正

**如果用户想要调整：**
- 接受反馈并进行调整
- 调整后重新验证

### 7. 确认完成

显示：

"**PRD 编辑完成**

**已应用的更改：** {count} 个部分已修改
**PRD 已更新：** {prd_file_path}

**更改摘要：**
{Brief bullet list of major changes}

**PRD 准备好用于：**
- 下游工作流（UX 设计，架构）
- 验证（如果尚未验证）

**你接下来想做什么？**"

### 8. 展示菜单选项

**[V] 运行验证** - 执行完整验证工作流 (steps-v/step-v-01-discovery.md)
**[S] 仅摘要** - 以更改摘要结束（不验证）
**[A] 调整** - 进行额外编辑
**[X] 退出** - 退出编辑工作流

#### 执行规则：

- 始终 停止并等待用户输入
- 仅根据用户选择继续

#### 菜单处理逻辑：

- 如果 V (验证): 显示 "正在启动验证工作流..." 然后完整阅读并遵循：steps-v/step-v-01-discovery.md
- 如果 S (摘要): 展示编辑摘要并退出
- 如果 A (调整): 接受额外要求，循环回到编辑
- 如果 X (退出): 显示摘要并退出

---

## 🚨 系统成功/失败指标

### ✅ 成功：

- 步骤 e-02 的所有已批准更改已正确应用
- 更改按计划优先级顺序执行
- 重组已完成（如果需要）
- Frontmatter 更新准确
- 最终验证确认更改
- 用户可以继续验证或以摘要退出
- 运行验证的选项无缝集成编辑和验证模式

### ❌ 系统失败：

- 超出已批准计划进行更改
- 未遵循优先级顺序
- 缺少重组（如果转换模式）
- 未更新 frontmatter
- 无最终验证
- 未保存更新后的 PRD

**主规则：** 严格按照批准执行计划。PRD 现在准备好用于验证或下游使用。验证集成确保质量。
