---
name: 'step-e-01-discovery'
description: '发现与理解 - 了解用户想要编辑的内容并检测 PRD 格式'

# File references (ONLY variables used in this step)
# File references (ONLY variables used in this step)
altStepFile: 'references/step-e-01b-legacy-conversion.md'
prdPurpose: 'references/prd-purpose.md'
advancedElicitationTask: 'references/advanced-elicitation.workflow.xml'

---

# 步骤 E-1: 发现与理解

## 步骤目标：

了解用户想要在 PRD 中编辑什么，检测 PRD 格式/类型，检查验证报告指导，并进行适当的路由。

## 强制执行规则 (请先阅读):

### 通用规则：

- 🛑 绝不 在没有用户输入的情况下生成内容
- 📖 关键：在采取任何行动之前，请阅读完整的步骤文件
- 🔄 关键：当使用 'C' 加载下一步时，确保已阅读整个文件
- 📋 你是一个协调员，而不是内容生成器
- ✅ 你必须始终使用配置的 `{communication_language}` 以你的 Agent 沟通风格输出语言

### 角色强化：

- ✅ 你是验证架构师和 PRD 改进专家
- ✅ 如果你已经被赋予了沟通或人物模式，在扮演这个新角色时继续使用它们
- ✅ 我们参与协作对话，而不是命令-响应
- ✅ 你带来分析专业知识和改进指导
- ✅ 用户带来领域专业知识和编辑要求

### 步骤特定规则：

- 🎯 仅关注 发现用户意图和 PRD 格式
- 🚫 禁止 此时进行任何编辑
- 💬 方法：好奇和分析，在行动前理解
- 🚪 这是一个分支步骤 - 可能路由到遗留转换

## 执行协议：

- 🎯 发现用户的编辑要求
- 🎯 自动检测 PRD 文件夹中的验证报告（用作指南）
- 🎯 加载验证报告（如果提供）（用作指南）
- 🎯 检测 PRD 格式（BMAD/遗留）
- 🎯 根据格式进行适当路由
- 💾 记录发现内容以便下一步使用
- 🚫 禁止 在不了解要求的情况下继续

## 上下文边界：

- 可用上下文：要编辑的 PRD 文件，可选的验证报告，自动检测到的验证报告
- 重点：仅用户意图发现和格式检测
- 限制：还没有编辑，还没有验证
- 依赖项：无 - 这是第一个编辑步骤

## 强制序列

**关键：** 严格遵循此序列。除非用户明确要求更改，否则不要跳过、重新排序或即兴发挥。

### 1. 加载 PRD 目的标准

加载并阅读完整文件：
`{prdPurpose}` (data/prd-purpose.md)

此文件定义了什么构成了伟大的 BMAD PRD。内化这种理解 - 它将指导改进建议。

### 2. 发现要编辑的 PRD

"**PRD 编辑工作流**

你想编辑哪个 PRD？

请提供你想编辑的 PRD 文件的路径。"

**等待用户提供 PRD 路径。**

### 3. 验证 PRD 是否存在并加载

一旦提供 PRD 路径：
- 检查指定路径是否存在 PRD 文件
- 如果未找到："我无法在该路径找到 PRD。请检查路径并重试。"
- 如果找到：加载完整的 PRD 文件，包括 frontmatter

### 4. 检查现有的验证报告

**检查 PRD 文件夹中是否存在验证报告：**

```bash
# Look for most recent validation report in the PRD folder
ls -t {prd_folder_path}/validation-report-*.md 2>/dev/null | head -1
```

**如果找到验证报告：**

显示：
"**📋 发现验证报告**

我在 PRD 文件夹中找到了来自 {validation_date} 的验证报告。

此报告包含先前验证检查的发现，可以帮助指导我们的编辑以修复已知问题。

**你想：**
- **[U] 使用验证报告** - 加载它以指导和优先处理编辑
- **[S] 跳过** - 继续手动编辑发现"

**等待用户输入。**

**如果 U (使用验证报告):**
- 加载验证报告文件
- 提取发现、问题和改进建议
- 注意："验证报告已加载 - 将使用它来指导优先改进"
- 继续到第 5 步

**如果 S (跳过) 或未找到验证报告:**
- 注意："继续手动编辑发现"
- 继续到第 5 步 

**如果未找到验证报告:**
- 注意："在 PRD 文件夹中未找到验证报告"
- 继续到第 5 步，不询问用户

### 5. 询问验证报告

"**你有验证报告来指导编辑吗？**

如果你已经对此 PRD 运行了验证工作流，我可以使用该报告来指导改进和优先处理更改。

验证报告路径（或输入 'none'）："

**等待用户输入。**

**如果提供验证报告路径：**
- 加载验证报告
- 提取发现、严重性、改进建议
- 注意："验证报告已加载 - 将使用它来指导优先改进"

**如果无验证报告：**
- 注意："继续手动编辑发现"
- 继续到第 6 步

### 6. 发现编辑要求

"**你想在此 PRD 中编辑什么？**

请描述你想做的更改。例如：
- 修复特定问题（信息密度、实施泄漏等）
- 添加缺失的部分或内容
- 改善结构和流程
- 转换为 BMAD 格式（如果是遗留 PRD）
- 一般改进
- 其他更改

**描述你的编辑目标：**"

**等待用户描述他们的要求。**

### 7. 检测 PRD 格式

分析已加载的 PRD：

**从 PRD 中提取所有 ## 2 级标题**

**检查 BMAD PRD 核心部分：**
1. 执行摘要
2. 成功标准
3. 产品范围
4. 用户旅程
5. 功能需求
6. 非功能需求

**分类格式：**
- **BMAD 标准：** 5-6 个核心部分存在
- **BMAD 变体：** 3-4 个核心部分存在，通常遵循 BMAD 模式
- **遗留（非标准）：** 少于 3 个核心部分，不遵循 BMAD 结构

### 8. 根据格式和上下文路由

**如果提供了验证报告 或 PRD 是 BMAD 标准/变体：**

显示："**编辑要求已理解**

**PRD 格式：** {classification}
{If validation report: "**验证指南：** 是 - 将使用验证报告发现"}
**编辑目标：** {summary of user's requirements}

**正在进行深度审查和分析...**"

完整阅读并遵循：下一步 (step-e-02-review.md)

**如果 PRD 是遗留（非标准）且无验证报告：**

显示："**检测到格式：** 遗留 PRD

此 PRD 不遵循 BMAD 标准结构（仅存在 {count}/6 个核心部分）。

**你的编辑目标：** {user's requirements}

**你想如何继续？**"

在下方展示菜单选项供用户选择

### 9. 展示菜单选项（仅限遗留 PRD）

**[C] 转换为 BMAD 格式** - 将 PRD 转换为 BMAD 标准结构，然后应用你的编辑
**[E] 原样编辑** - 应用你的编辑而不转换格式
**[X] 退出** - 退出并审查转换选项

#### 执行规则：

- 始终 停止并等待用户输入
- 仅根据用户选择继续

#### 菜单处理逻辑：

- 如果 C (转换): 完整阅读并遵循：{altStepFile} (step-e-01b-legacy-conversion.md)
- 如果 E (原样编辑): 显示 "正在进行编辑..." 然后加载下一步
- 如果 X (退出): 显示摘要并退出
- 如果 其他: 帮助用户，然后重新显示菜单

---

## 🚨 系统成功/失败指标

### ✅ 成功：

- 清楚理解用户的编辑要求
- 自动检测到的验证报告已加载并分析（当找到时）
- 手动验证报告已加载并分析（如果提供）
- 正确检测 PRD 格式
- BMAD PRD 直接进入审查步骤
- 遗留 PRD 暂停并展示转换选项
- 用户可以选择转换路径或原样编辑

### ❌ 系统失败：

- 未发现用户的编辑要求
- 未在 PRD 文件夹中自动检测验证报告
- 未加载验证报告（自动或手动）
- 缺少格式检测
- 遗留 PRD 未经指导即暂停
- 未了解意图即自动继续

**主规则：** 编辑前先理解。尽早检测格式，以便我们可以适当地指导用户。自动检测并使用验证报告以进行优先改进。
