---
name: 'step-e-02-review'
description: '深度审查与分析 - 彻底审查现有 PRD 并准备详细的变更计划'

# File references (ONLY variables used in this step)
nextStepFile: './step-e-03-edit.md'
prdFile: '{prd_file_path}'
validationReport: '{validation_report_path}'  # If provided
prdPurpose: 'references/prd-purpose.md'
advancedElicitationTask: 'references/advanced-elicitation.workflow.xml'
---

# 步骤 E-2: 深度审查与分析

## 步骤目标：

彻底审查现有 PRD，分析验证报告发现（如果提供），并在编辑前准备详细的变更计划。

## 强制执行规则 (请先阅读):

### 通用规则：

- 🛑 绝不 在没有用户输入的情况下生成内容
- 📖 关键：在采取任何行动之前，请阅读完整的步骤文件
- 🔄 关键：当使用 'C' 加载下一步时，确保已阅读整个文件
- 📋 你是一个协调员，而不是内容生成器
- ✅ 你必须始终使用配置的 `{communication_language}` 以你的 Agent 沟通风格输出语言

### 角色强化：

- ✅ 你是验证架构师和 PRD 改进专家
- ✅ 如果你已经被赋予了沟通或人物模式，在扮演这个新角色时继续使用它们
- ✅ 我们参与协作对话，而不是命令-响应
- ✅ 你带来分析专业知识和改进规划
- ✅ 用户带来领域专业知识和批准权

### 步骤特定规则：

- 🎯 仅关注 审查和分析，尚未编辑
- 🚫 禁止 在此步骤中更改 PRD
- 💬 方法：彻底分析并在计划上获得用户确认
- 🚪 这是一个中间步骤 - 用户在继续之前确认为计划

## 执行协议：

- 🎯 加载并分析验证报告（如果提供）
- 🎯 深度审查整个 PRD
- 🎯 将验证发现映射到特定部分
- 🎯 准备详细的变更计划
- 💬 获得用户对计划的确认
- 🚫 禁止 在没有用户批准的情况下继续编辑

## 上下文边界：

- 可用上下文：PRD 文件，验证报告（如果提供），来自步骤 e-01 的用户要求
- 重点：仅分析和规划（无编辑）
- 限制：还没有更改 PRD，还没有验证
- 依赖项：步骤 e-01 已完成 - 要求和格式已知

## 强制序列

**关键：** 严格遵循此序列。除非用户明确要求更改，否则不要跳过、重新排序或即兴发挥。

### 1. 尝试子流程深度审查

**尝试使用带有子代理的 Task 工具：**

"执行深度 PRD 审查和变更规划：

**来自步骤 e-01 的上下文：**
- 用户的编辑要求：{user_requirements}
- PRD 格式：{BMAD/legacy}
- 验证报告已提供：{yes/no}
- 转换模式：{restructure/targeted/both} (如果是遗留)

**如果提供了验证报告：**
1. 从验证报告中提取所有发现
2. 将发现映射到特定的 PRD 部分
3. 按严重性优先排序：严重 > 警告 > 信息
4. 对于每个严重问题：识别所需的具体修复
5. 对于用户的手动编辑目标：识别在 PRD 中应用的位​​置

**如果无验证报告：**
1. 彻底阅读整个 PRD
2. 根据 BMAD 标准（来自 prd-purpose.md）进行分析
3. 识别问题：
   - 信息密度（反模式）
   - 结构和流程
   - 完整性（缺少部分/内容）
   - 可测量性（不可测量的要求）
   - 可追溯性（断裂链）
   - 实施泄漏
4. 将用户的编辑目标映射到特定部分

**输出：**
- 逐节分析
- 每个部分所需的具体更改
- 优先行动列表
- 应用更改的推荐顺序

返回带有部分细分的详细变更计划。"

**优雅降级（如果没有 Task 工具）：**
- 手动阅读 PRD 部分
- 手动分析验证报告发现（如果提供）
- 构建逐节变更计划
- 按严重性/用户目标优先处理更改

### 2. 构建变更计划

**按 PRD 部分组织：**

**对于每个部分（按顺序）：**
- **当前状态：** 简要描述存在的内容
- **识别出的问题：** [来自验证报告或手动分析的列表]
- **所需更改：** [所需的具体更改]
- **优先级：** [严重/高/中/低]
- **满足的用户要求：** [哪个用户编辑目标解决了此部分]

**包括：**
- 要添加的部分（如果缺失）
- 要更新的部分（如果存在但需要工作）
- 要删除的内容（如果不正确/泄漏）
- 结构更改（如果需要重新格式化）

### 3. 准备变更计划摘要

**摘要部分：**

**按类型更改：**
- **添加：** {count} 个要添加的部分
- **更新：** {count} 个要更新的部分
- **删除：** {count} 个要删除的项目
- **重组：** {yes/no} 如果需要格式转换

**优先级分布：**
- **严重：** {count} 个更改（必须修复）
- **高：** {count} 个更改（重要）
- **中：** {count} 个更改（有也没错）
- **低：** {count} 个更改（可选）

**估算工作量：**
[快速/中等/大量] 基于范围和复杂性

### 4. 向用户展示变更计划

显示：

"**深度审查完成 - 变更计划**

**PRD 分析：**
{Brief summary of PRD current state}

{If validation report provided:}
**验证发现：**
{count} 个问题已识别：{critical} 个严重，{warning} 个警告

**你的编辑要求：**
{summary of what user wants to edit}

**提议的变更计划：**

**按部分：**
{Present section-by-section breakdown}

**按优先级：**
- 严重：{count} 个项目
- 高：{count} 个项目
- 中：{count} 个项目

**估算工作量：** {effort level}

**问题：**
1. 这个变更计划是否符合你的想法？
2. 有什么我应该添加/删除/重新优先排序的部分吗？
3. 在我进行编辑之前有什么顾虑吗？

**审查计划，如果你想要任何调整，请告诉我。**"

### 5. 获得用户确认

等待用户审查并提供反馈。

**如果用户想要调整：**
- 讨论请求的更改
- 相应地修改变更计划
- 重新呈现以供确认

**如果用户批准：**
- 注意："变更计划已批准。继续进行编辑步骤。"
- 继续到第 6 步

### 6. 记录已批准的计划

存储已批准的变更计划以便下一步使用：

- **已批准的更改：** 逐节列表
- **优先级顺序：** 应用更改的顺序
- **用户确认：** 是

显示： "**变更计划已批准**

{Brief summary of approved plan}

**正在进行编辑步骤...**"

完整阅读并遵循：{nextStepFile} (step-e-03-edit.md)

### 7. 展示菜单选项（如果用户想要讨论）

**[A] 高级诱导** - 获得关于变更计划的额外观点
**[P] 派对模式** - 与团队讨论更多想法
**[C] 继续编辑** - 继续已批准的计划

#### 执行规则：

- 始终 停止并等待用户输入
- 仅当用户选择 'C' 时才进行编辑

#### 菜单处理逻辑：

- 如果 A: 完整阅读并遵循：{advancedElicitationTask}，然后返回讨论

- 如果 C: 记录批准，然后加载 {nextStepFile}
- 如果 其他: 讨论，然后重新显示菜单

---

## 🚨 系统成功/失败指标

### ✅ 成功：

- 验证报告发现已完全分析（如果提供）
- 深度 PRD 审查系统地完成
- 逐节构建变更计划
- 更改按严重性/用户目标优先排序
- 向用户展示清晰的计划
- 用户确认或调整计划
- 已批准的计划记录以便下一步使用

### ❌ 系统失败：

- 未分析验证报告发现（如果提供）
- 肤浅的审查而不是深度分析
- 缺少逐节细分
- 未优先处理更改
- 在没有用户批准的情况下继续

**主规则：** 编辑前计划。彻底的分析确保我们在正确的顺序做出的正确的更改。用户批准防止错位。
