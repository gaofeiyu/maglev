---
name: 'step-v-02-format-detection'
description: '格式检测与结构分析 - 分类 PRD 格式并适当路由'

# File references (ONLY variables used in this step)
nextStepFile: './step-v-03-density-validation.md'
altStepFile: './step-v-02b-parity-check.md'
prdFile: '{prd_file_path}'
validationReportPath: '{validation_report_path}'
---

# 步骤 2: 格式检测与结构分析

## 步骤目标：

检测 PRD 是否遵循 BMAD 格式并进行适当路由 - 分类为 BMAD 标准 / BMAD 变体 / 非标准，并对非标准格式进行可选的平价检查。

## 强制执行规则 (请先阅读):

### 通用规则：

- 🛑 绝不 在没有用户输入的情况下生成内容
- 📖 关键：在采取任何行动之前，请阅读完整的步骤文件
- 🔄 关键：当使用 'C' 加载下一步时，确保已阅读整个文件
- 📋 你是一个协调员，而不是内容生成器
- ✅ 你必须始终使用配置的 `{communication_language}` 以你的 Agent 沟通风格输出语言

### 角色强化：

- ✅ 你是验证架构师和质量保证专家
- ✅ 如果你已经被赋予了沟通或人物模式，在扮演这个新角色时继续使用它们
- ✅ 我们参与协作对话，而不是命令-响应
- ✅ 你带来系统验证专业知识和模式识别
- ✅ 用户带来领域专业知识和 PRD 上下文

### 步骤特定规则：

- 🎯 仅关注 检测格式和分类结构
- 🚫 禁止 在此步骤中执行其他验证检查
- 💬 方法：分析和系统，向用户清晰报告发现
- 🚪 这是一个分支步骤 - 可能路由到非标准 PRD 的平价检查

## 执行协议：

- 🎯 系统地分析 PRD 结构
- 💾 将格式发现追加到验证报告
- 📖 根据格式分类进行适当路由
- 🚫 禁止 跳过格式检测或在没有分类的情况下继续

## 上下文边界：

- 可用上下文：步骤 1 中加载的 PRD 文件，已初始化的验证报告
- 重点：仅格式检测和分类
- 限制：不执行其他验证，不跳过分类
- 依赖项：步骤 1 已完成 - PRD 已加载且报告已初始化

## 强制序列

**关键：** 严格遵循此序列。除非用户明确要求更改，否则不要跳过、重新排序或即兴发挥。

### 1. 提取 PRD 结构

加载完整的 PRD 文件并提取：

**所有 2 级 (##) 标题：**
- 扫描整个 PRD 文档
- 提取所有 ## 部分标题
- 按顺序列出它们

**PRD frontmatter:**
- 如果存在，提取 classification.domain
- 如果存在，提取 classification.projectType
- 注意任何其他相关元数据

### 2. 检查 BMAD PRD 核心部分

检查 PRD 是否包含以下 BMAD PRD 核心部分：

1. **执行摘要** (或变体: ## Executive Summary, ## Overview, ## Introduction)
2. **成功标准** (或: ## Success Criteria, ## Goals, ## Objectives)
3. **产品范围** (或: ## Product Scope, ## Scope, ## In Scope, ## Out of Scope)
4. **用户旅程** (或: ## User Journeys, ## User Stories, ## User Flows)
5. **功能需求** (或: ## Functional Requirements, ## Features, ## Capabilities)
6. **非功能需求** (或: ## Non-Functional Requirements, ## NFRs, ## Quality Attributes)

**计算匹配项：**
- 这 6 个核心部分中有多少个存在？
- 具体存在哪些部分？
- 哪些缺失？

### 3. 分类 PRD 格式

根据核心部分计数进行分类：

**BMAD 标准：**
- 5-6 个核心部分存在
- 紧密遵循 BMAD PRD 结构

**BMAD 变体：**
- 3-4 个核心部分存在
- 通常遵循 BMAD 模式，但可能有结构差异
- 缺少某些部分但可识别为 BMAD 风格

**非标准：**
- 少于 3 个核心部分存在
- 不遵循 BMAD PRD 结构
- 可能是完全自定义格式、遗留格式或来自其他框架

### 4. 向验证报告报告格式发现

追加到验证报告：

```markdown
## 格式检测

**PRD 结构:**
[List all ## Level 2 headers found]

**存在的 BMAD 核心部分:**
- 执行摘要: [存在/缺失]
- 成功标准: [存在/缺失]
- 产品范围: [存在/缺失]
- 用户旅程: [存在/缺失]
- 功能需求: [存在/缺失]
- 非功能需求: [存在/缺失]

**格式分类:** [BMAD 标准 / BMAD 变体 / 非标准]
**存在的核心部分:** [count]/6
```

### 5. 根据格式分类进行路由

**如果格式是 BMAD 标准或 BMAD 变体：**

显示："**检测到格式：** {classification}

正在进行系统验证检查..."

毫不延迟，完整阅读并遵循：{nextStepFile} (step-v-03-density-validation.md)

**如果格式是非标准 (< 3 个核心部分)：**

显示："**检测到格式：** 非标准 PRD

此 PRD 不遵循 BMAD 标准结构（仅存在 {count}/6 个核心部分）。

你有以下选择："

在下方展示菜单选项供用户选择

### 6. 展示菜单选项（仅限非标准 PRD）

**[A] 平价检查** - 分析差距并估算达到 BMAD PRD 平价的工作量
**[B] 原样验证** - 使用当前结构继续验证
**[C] 退出** - 退出验证并审查格式发现

#### 执行规则：

- 始终 停止并等待用户输入
- 仅根据用户选择继续

#### 菜单处理逻辑：

- 如果 A (平价检查): 完整阅读并遵循：{altStepFile} (step-v-02b-parity-check.md)
- 如果 B (原样验证): 显示 "继续验证..." 然后完整阅读并遵循：{nextStepFile}
- 如果 C (退出): 显示格式发现摘要并退出验证
- 如果 其他: 帮助用户响应，然后重新显示菜单

---

## 🚨 系统成功/失败指标

### ✅ 成功：

- 成功提取所有 ## 2 级标题
- 系统地检查 BMAD 核心部分
- 根据部分计数正确分类格式
- 将发现报告给验证报告
- BMAD 标准/变体 PRD 直接进入下一个验证步骤
- 非标准 PRD 暂停并向用户展示选项
- 用户可以选择平价检查、原样验证或退出

### ❌ 系统失败：

- 在分类前未提取所有标题
- 格式分类不正确
- 未将发现报告给验证报告
- 未对非标准 PRD 暂停
- 在没有用户决定的情况下继续处理非标准格式

**主规则：** 格式检测决定验证路径。非标准 PRD 在继续之前需要用户选择。
